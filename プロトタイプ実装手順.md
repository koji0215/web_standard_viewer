# ステップ1: 最小機能プロトタイプの実装手順

## 概要

この文書では、「時系列データ確認機能の実装可能性についてのまとめ」の12.2節で提案された「ステップ1: 最小機能プロトタイプ（1ヶ月）」の具体的な実装手順を説明します。

**目標**:
- FastAPI + SQLiteでシンプルなAPI構築
- 少数の天体（100個程度）でテスト
- フロントエンドに最小限のライトカーブ表示機能を追加
- 技術検証、UI/UXの確認

**期間**: 約1ヶ月（4週間）

---

## 実装スケジュール

| 週 | タスク | 成果物 |
|---|--------|--------|
| 第1週 | 環境構築とデータ準備 | 開発環境、サンプルデータ |
| 第2週 | バックエンドAPI実装 | FastAPI + SQLite |
| 第3週 | フロントエンド実装 | ライトカーブ表示UI |
| 第4週 | 統合テストと評価 | 動作確認、改善点リスト |

---

## 第1週: 環境構築とデータ準備

### 1.1 開発環境のセットアップ

#### 必要なソフトウェア

```bash
# Python 3.9以上をインストール
python3 --version  # 3.9以上であることを確認

# 仮想環境の作成
cd /path/to/web_standard_viewer
mkdir backend
cd backend
python3 -m venv venv

# 仮想環境の有効化
source venv/bin/activate  # Linux/Mac
# または
venv\Scripts\activate  # Windows
```

#### 必要なPythonパッケージのインストール

```bash
# requirements.txtを作成
cat > requirements.txt << EOF
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
python-multipart==0.0.6
astropy==5.3.4
numpy==1.26.2
pandas==2.1.3
EOF

# パッケージをインストール
pip install -r requirements.txt
```

### 1.2 NEOWISEサンプルデータの準備

#### 1.2.1 データダウンロード

NEOWISEの公開データから、プロトタイプ用に100個程度の天体のライトカーブデータを準備します。

**オプションA: IRSAから手動でダウンロード**

1. IRSAのNEOWISE Light Curveサービスにアクセス:
   https://irsa.ipac.caltech.edu/applications/NEOWISE-LC/

2. 以下の条件で検索:
   - 明るい天体（W1 < 12 mag）を優先
   - 観測回数が多い天体（> 50回）
   - サンプルとして100個程度

3. 結果をCSVまたはFITSフォーマットでダウンロード

**オプションB: astropyを使用して自動取得（推奨）**

```python
# scripts/download_neowise_sample.py
from astropy.coordinates import SkyCoord
from astropy import units as u
from astroquery.irsa import Irsa
import pandas as pd
import json
import os

def download_neowise_lightcurves(catalog_file, output_dir, max_objects=100):
    """
    カタログファイルから天体を読み込み、NEOWISEライトカーブをダウンロード
    
    Parameters:
    - catalog_file: 入力カタログ（CSV）のパス
    - output_dir: 出力ディレクトリ
    - max_objects: ダウンロードする最大天体数
    """
    # カタログを読み込み
    catalog = pd.read_csv(catalog_file)
    
    # 出力ディレクトリを作成
    os.makedirs(output_dir, exist_ok=True)
    
    downloaded = 0
    
    for idx, row in catalog.iterrows():
        if downloaded >= max_objects:
            break
        
        try:
            ra = row['ra']
            dec = row['dec']
            
            # AllWISE IDがあればそれを使用
            if 'allwise_id' in row and pd.notna(row['allwise_id']):
                allwise_id = row['allwise_id']
                print(f"Processing {allwise_id}...")
            else:
                allwise_id = f"J{ra:09.5f}{dec:+09.5f}".replace('.', '')
                print(f"Processing RA={ra:.5f}, Dec={dec:.5f}...")
            
            # NEOWISEデータを検索（3秒角以内）
            coord = SkyCoord(ra=ra*u.degree, dec=dec*u.degree, frame='icrs')
            
            # ここでは実際のIRSAクエリの代わりに、ダミーデータを作成
            # 実際の実装では、IRSAのAPIを使用してデータを取得
            lightcurve_data = generate_dummy_lightcurve(ra, dec, allwise_id)
            
            # JSONファイルとして保存
            output_file = os.path.join(output_dir, f"{allwise_id}.json")
            with open(output_file, 'w') as f:
                json.dump(lightcurve_data, f, indent=2)
            
            downloaded += 1
            print(f"  Saved to {output_file}")
            
        except Exception as e:
            print(f"  Error: {e}")
            continue
    
    print(f"\nDownloaded {downloaded} light curves")

def generate_dummy_lightcurve(ra, dec, allwise_id):
    """
    プロトタイプ用のダミーライトカーブを生成
    実際の実装では、IRSAから取得したデータを使用
    """
    import numpy as np
    
    # 2010年から2023年まで、約6ヶ月ごとの観測を想定
    num_obs = np.random.randint(30, 100)
    mjd_start = 55197.0  # 2010-01-01
    mjd_end = 59945.0     # 2023-01-01
    mjds = np.sort(np.random.uniform(mjd_start, mjd_end, num_obs))
    
    # W1バンドの平均等級（ランダム）
    w1_mean = np.random.uniform(10.0, 14.0)
    w1_rms = np.random.uniform(0.02, 0.1)
    
    # W2バンドの平均等級
    w2_mean = w1_mean + np.random.uniform(-0.5, 0.5)
    w2_rms = np.random.uniform(0.02, 0.1)
    
    observations = []
    for mjd in mjds:
        obs = {
            "mjd": float(mjd),
            "w1_mag": float(w1_mean + np.random.normal(0, w1_rms)),
            "w1_err": float(np.random.uniform(0.02, 0.05)),
            "w2_mag": float(w2_mean + np.random.normal(0, w2_rms)),
            "w2_err": float(np.random.uniform(0.02, 0.05))
        }
        observations.append(obs)
    
    return {
        "allwise_id": allwise_id,
        "ra": float(ra),
        "dec": float(dec),
        "num_observations": len(observations),
        "observations": observations
    }

if __name__ == "__main__":
    # 既存のカタログファイル（BrightKg_WISE_unique.csv）を使用
    catalog_file = "../BrightKg_WISE_unique.csv"
    output_dir = "./data/lightcurves"
    
    download_neowise_lightcurves(catalog_file, output_dir, max_objects=100)
```

#### 1.2.2 スクリプトの実行

```bash
cd backend
mkdir -p scripts data/lightcurves

# スクリプトを作成（上記のコードをコピー）
# scripts/download_neowise_sample.py

# 実行
python scripts/download_neowise_sample.py
```

### 1.3 データベースの設計と作成

#### 1.3.1 データベーススキーマ

```sql
-- backend/schema.sql

-- ライトカーブのメタデータテーブル
CREATE TABLE lightcurves (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    allwise_id TEXT UNIQUE NOT NULL,
    ra REAL NOT NULL,
    dec REAL NOT NULL,
    num_observations INTEGER NOT NULL,
    w1_mean REAL,
    w1_rms REAL,
    w2_mean REAL,
    w2_rms REAL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 座標検索用のインデックス
CREATE INDEX idx_ra_dec ON lightcurves(ra, dec);
CREATE INDEX idx_allwise_id ON lightcurves(allwise_id);

-- 観測データテーブル
CREATE TABLE observations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    lightcurve_id INTEGER NOT NULL,
    mjd REAL NOT NULL,
    w1_mag REAL,
    w1_err REAL,
    w2_mag REAL,
    w2_err REAL,
    FOREIGN KEY (lightcurve_id) REFERENCES lightcurves(id)
);

-- 観測データの検索用インデックス
CREATE INDEX idx_lightcurve_id ON observations(lightcurve_id);
CREATE INDEX idx_mjd ON observations(mjd);
```

#### 1.3.2 データベース作成スクリプト

```python
# scripts/create_database.py
import sqlite3
import json
import os
from pathlib import Path

def create_database(db_path, schema_path, lightcurves_dir):
    """
    データベースを作成し、ライトカーブデータを投入
    """
    # データベースを作成
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # スキーマを読み込んで実行
    with open(schema_path, 'r') as f:
        schema = f.read()
    cursor.executescript(schema)
    
    print(f"Database created: {db_path}")
    
    # ライトカーブデータを投入
    lightcurve_files = Path(lightcurves_dir).glob("*.json")
    
    imported = 0
    for lc_file in lightcurve_files:
        try:
            with open(lc_file, 'r') as f:
                data = json.load(f)
            
            # ライトカーブのメタデータを挿入
            cursor.execute(
                """
                INSERT INTO lightcurves 
                (allwise_id, ra, dec, num_observations, w1_mean, w1_rms, w2_mean, w2_rms)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                """,
                (
                    data['allwise_id'],
                    data['ra'],
                    data['dec'],
                    data['num_observations'],
                    None,  # w1_mean は後で計算
                    None,  # w1_rms は後で計算
                    None,  # w2_mean は後で計算
                    None   # w2_rms は後で計算
                )
            )
            
            lightcurve_id = cursor.lastrowid
            
            # 観測データを挿入
            for obs in data['observations']:
                cursor.execute(
                    """
                    INSERT INTO observations
                    (lightcurve_id, mjd, w1_mag, w1_err, w2_mag, w2_err)
                    VALUES (?, ?, ?, ?, ?, ?)
                    """,
                    (
                        lightcurve_id,
                        obs['mjd'],
                        obs['w1_mag'],
                        obs['w1_err'],
                        obs['w2_mag'],
                        obs['w2_err']
                    )
                )
            
            # 統計情報を計算して更新
            cursor.execute(
                """
                UPDATE lightcurves
                SET w1_mean = (
                    SELECT AVG(w1_mag) FROM observations 
                    WHERE lightcurve_id = ?
                ),
                w1_rms = (
                    SELECT 
                        SQRT(AVG((w1_mag - (SELECT AVG(w1_mag) FROM observations WHERE lightcurve_id = ?)) * 
                                 (w1_mag - (SELECT AVG(w1_mag) FROM observations WHERE lightcurve_id = ?))))
                    FROM observations 
                    WHERE lightcurve_id = ?
                ),
                w2_mean = (
                    SELECT AVG(w2_mag) FROM observations 
                    WHERE lightcurve_id = ?
                ),
                w2_rms = (
                    SELECT 
                        SQRT(AVG((w2_mag - (SELECT AVG(w2_mag) FROM observations WHERE lightcurve_id = ?)) * 
                                 (w2_mag - (SELECT AVG(w2_mag) FROM observations WHERE lightcurve_id = ?))))
                    FROM observations 
                    WHERE lightcurve_id = ?
                )
                WHERE id = ?
                """,
                (lightcurve_id, lightcurve_id, lightcurve_id, lightcurve_id,
                 lightcurve_id, lightcurve_id, lightcurve_id, lightcurve_id,
                 lightcurve_id)
            )
            
            imported += 1
            if imported % 10 == 0:
                print(f"Imported {imported} light curves...")
            
        except Exception as e:
            print(f"Error importing {lc_file}: {e}")
            continue
    
    conn.commit()
    conn.close()
    
    print(f"\nTotal imported: {imported} light curves")
    print(f"Database ready: {db_path}")

if __name__ == "__main__":
    db_path = "./neowise_prototype.db"
    schema_path = "./schema.sql"
    lightcurves_dir = "./data/lightcurves"
    
    create_database(db_path, schema_path, lightcurves_dir)
```

#### 1.3.3 データベース作成の実行

```bash
cd backend

# スキーマファイルを作成
# schema.sql（上記のSQLをコピー）

# スクリプトを作成
# scripts/create_database.py（上記のコードをコピー）

# 実行
python scripts/create_database.py
```

---

## 第2週: バックエンドAPI実装

### 2.1 FastAPIアプリケーションの基本構造

#### 2.1.1 ディレクトリ構造

```
backend/
├── venv/                    # 仮想環境
├── data/
│   └── lightcurves/        # サンプルデータ（JSON）
├── scripts/                # ユーティリティスクリプト
│   ├── download_neowise_sample.py
│   └── create_database.py
├── app/                    # FastAPIアプリケーション
│   ├── __init__.py
│   ├── main.py            # メインアプリケーション
│   ├── models.py          # Pydanticモデル
│   ├── database.py        # データベース接続
│   └── api/
│       ├── __init__.py
│       └── lightcurves.py # ライトカーブAPI
├── neowise_prototype.db   # SQLiteデータベース
├── schema.sql
└── requirements.txt
```

### 2.2 データベース接続の実装

```python
# app/database.py
import sqlite3
from contextlib import contextmanager
from typing import Generator

DATABASE_PATH = "./neowise_prototype.db"

@contextmanager
def get_db() -> Generator[sqlite3.Connection, None, None]:
    """
    データベース接続を取得するコンテキストマネージャー
    """
    conn = sqlite3.connect(DATABASE_PATH)
    conn.row_factory = sqlite3.Row  # 列名でアクセス可能にする
    try:
        yield conn
    finally:
        conn.close()

def get_lightcurve_by_id(allwise_id: str) -> dict | None:
    """
    AllWISE IDでライトカーブを取得
    """
    with get_db() as conn:
        cursor = conn.cursor()
        
        # メタデータを取得
        cursor.execute(
            "SELECT * FROM lightcurves WHERE allwise_id = ?",
            (allwise_id,)
        )
        row = cursor.fetchone()
        
        if not row:
            return None
        
        lightcurve_id = row['id']
        
        # 観測データを取得
        cursor.execute(
            "SELECT * FROM observations WHERE lightcurve_id = ? ORDER BY mjd",
            (lightcurve_id,)
        )
        observations = cursor.fetchall()
        
        return {
            "allwise_id": row['allwise_id'],
            "ra": row['ra'],
            "dec": row['dec'],
            "num_observations": row['num_observations'],
            "w1_mean": row['w1_mean'],
            "w1_rms": row['w1_rms'],
            "w2_mean": row['w2_mean'],
            "w2_rms": row['w2_rms'],
            "observations": [
                {
                    "mjd": obs['mjd'],
                    "w1_mag": obs['w1_mag'],
                    "w1_err": obs['w1_err'],
                    "w2_mag": obs['w2_mag'],
                    "w2_err": obs['w2_err']
                }
                for obs in observations
            ]
        }

def get_lightcurve_by_coord(ra: float, dec: float, radius: float = 3.0) -> dict | None:
    """
    座標でライトカーブを検索（最近傍）
    
    Parameters:
    - ra: 赤経（度）
    - dec: 赤緯（度）
    - radius: 検索半径（秒角）
    """
    # 簡易的な検索（球面三角法は使用せず、小角度近似）
    radius_deg = radius / 3600.0
    
    with get_db() as conn:
        cursor = conn.cursor()
        
        cursor.execute(
            """
            SELECT *, 
                   ((ra - ?) * (ra - ?) + (dec - ?) * (dec - ?)) AS dist_sq
            FROM lightcurves
            WHERE ABS(ra - ?) < ? AND ABS(dec - ?) < ?
            ORDER BY dist_sq
            LIMIT 1
            """,
            (ra, ra, dec, dec, ra, radius_deg, dec, radius_deg)
        )
        row = cursor.fetchone()
        
        if not row:
            return None
        
        # AllWISE IDを使って詳細データを取得
        return get_lightcurve_by_id(row['allwise_id'])
```

### 2.3 Pydanticモデルの定義

```python
# app/models.py
from pydantic import BaseModel, Field
from typing import List, Optional

class Observation(BaseModel):
    """
    個々の観測データ
    """
    mjd: float = Field(..., description="Modified Julian Date")
    w1_mag: float = Field(..., description="W1バンドの等級")
    w1_err: float = Field(..., description="W1バンドの誤差")
    w2_mag: float = Field(..., description="W2バンドの等級")
    w2_err: float = Field(..., description="W2バンドの誤差")

class LightCurve(BaseModel):
    """
    ライトカーブデータ
    """
    allwise_id: str = Field(..., description="AllWISE ID")
    ra: float = Field(..., description="赤経（度）")
    dec: float = Field(..., description="赤緯（度）")
    num_observations: int = Field(..., description="観測回数")
    w1_mean: Optional[float] = Field(None, description="W1バンドの平均等級")
    w1_rms: Optional[float] = Field(None, description="W1バンドのRMS")
    w2_mean: Optional[float] = Field(None, description="W2バンドの平均等級")
    w2_rms: Optional[float] = Field(None, description="W2バンドのRMS")
    observations: List[Observation] = Field(..., description="観測データのリスト")

class ErrorResponse(BaseModel):
    """
    エラーレスポンス
    """
    detail: str = Field(..., description="エラーメッセージ")
```

### 2.4 APIエンドポイントの実装

```python
# app/api/lightcurves.py
from fastapi import APIRouter, HTTPException, Query
from typing import Optional
from ..models import LightCurve, ErrorResponse
from ..database import get_lightcurve_by_id, get_lightcurve_by_coord

router = APIRouter(prefix="/api/lightcurve", tags=["lightcurves"])

@router.get(
    "/neowise",
    response_model=LightCurve,
    responses={
        404: {"model": ErrorResponse, "description": "Light curve not found"},
        400: {"model": ErrorResponse, "description": "Bad request"}
    },
    summary="NEOWISEライトカーブを取得",
    description="AllWISE IDまたは座標でNEOWISEライトカーブを検索して取得します"
)
async def get_neowise_lightcurve(
    allwise_id: Optional[str] = Query(
        None,
        description="AllWISE ID（例: J123456.78+901234.5）",
        example="J123456.78+901234.5"
    ),
    ra: Optional[float] = Query(
        None,
        ge=0.0,
        le=360.0,
        description="赤経（度、0-360）",
        example=188.753
    ),
    dec: Optional[float] = Query(
        None,
        ge=-90.0,
        le=90.0,
        description="赤緯（度、-90~90）",
        example=-20.086
    ),
    radius: float = Query(
        3.0,
        gt=0.0,
        le=60.0,
        description="検索半径（秒角、最大60秒角）",
        example=3.0
    )
):
    """
    NEOWISEライトカーブを取得
    
    - **allwise_id**: AllWISE IDで検索（優先）
    - **ra, dec**: 座標で検索（AllWISE IDが指定されていない場合）
    - **radius**: 座標検索時の検索半径（秒角）
    """
    # パラメータの検証
    if not allwise_id and (ra is None or dec is None):
        raise HTTPException(
            status_code=400,
            detail="allwise_id または (ra, dec) のいずれかを指定してください"
        )
    
    # データを取得
    if allwise_id:
        data = get_lightcurve_by_id(allwise_id)
    else:
        data = get_lightcurve_by_coord(ra, dec, radius)
    
    if not data:
        raise HTTPException(
            status_code=404,
            detail="指定された条件に一致するライトカーブが見つかりませんでした"
        )
    
    return data
```

### 2.5 メインアプリケーションの実装

```python
# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from .api import lightcurves

app = FastAPI(
    title="NEOWISE Light Curve API (Prototype)",
    description="NEOWISEライトカーブを取得するためのプロトタイプAPI",
    version="0.1.0"
)

# CORS設定（開発環境用）
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 本番環境では制限する
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ルーターを登録
app.include_router(lightcurves.router)

@app.get("/")
async def root():
    """
    ルートエンドポイント
    """
    return {
        "message": "NEOWISE Light Curve API (Prototype)",
        "version": "0.1.0",
        "docs": "/docs"
    }

@app.get("/health")
async def health_check():
    """
    ヘルスチェックエンドポイント
    """
    return {"status": "ok"}
```

```python
# app/__init__.py
# 空ファイル（パッケージとして認識させるため）
```

```python
# app/api/__init__.py
# 空ファイル
```

### 2.6 APIサーバーの起動と動作確認

```bash
cd backend

# サーバーを起動（開発モード）
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 別のターミナルで動作確認
# 1. ルートエンドポイント
curl http://localhost:8000/

# 2. ヘルスチェック
curl http://localhost:8000/health

# 3. AllWISE IDで検索（実際のIDに置き換える）
curl "http://localhost:8000/api/lightcurve/neowise?allwise_id=J000001.23+012345.6"

# 4. 座標で検索
curl "http://localhost:8000/api/lightcurve/neowise?ra=188.753&dec=-20.086&radius=3"

# 5. Swagger UIで確認
# ブラウザで http://localhost:8000/docs にアクセス
```

---

## 第3週: フロントエンド実装

### 3.1 Chart.jsの導入

既存の`index.html`または`viewer.html`に、Chart.jsを追加します。

```html
<!-- index.html または viewer.html の<head>内に追加 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
```

### 3.2 ライトカーブモーダルUIの追加

```html
<!-- index.html または viewer.html の<body>内、既存のコンテンツの後に追加 -->

<!-- ライトカーブモーダル -->
<div id="lightcurve-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>Light Curve</h2>
            <span class="close" onclick="closeLightCurveModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- ターゲット情報 -->
            <div id="lc-target-info" class="lc-info">
                <p><strong>AllWISE ID:</strong> <span id="lc-allwise-id">-</span></p>
                <p><strong>RA, Dec:</strong> <span id="lc-coord">-</span></p>
            </div>
            
            <!-- データソース選択 -->
            <div class="lc-controls">
                <label>
                    <input type="radio" name="lc-band" value="w1" checked onchange="updateLightCurveDisplay()">
                    W1 (3.4μm)
                </label>
                <label>
                    <input type="radio" name="lc-band" value="w2" onchange="updateLightCurveDisplay()">
                    W2 (4.6μm)
                </label>
            </div>
            
            <!-- ローディング表示 -->
            <div id="lc-loading" class="lc-loading" style="display: none;">
                <p>Loading light curve...</p>
            </div>
            
            <!-- エラー表示 -->
            <div id="lc-error" class="lc-error" style="display: none;">
                <p id="lc-error-message">Error loading light curve</p>
            </div>
            
            <!-- グラフ表示エリア -->
            <div id="lc-chart-container" style="position: relative; height: 400px;">
                <canvas id="lightcurve-chart"></canvas>
            </div>
            
            <!-- 統計情報 -->
            <div id="lc-stats" class="lc-stats">
                <p><strong>Observations:</strong> <span id="lc-num-obs">-</span></p>
                <p><strong>Mean:</strong> <span id="lc-mean">-</span> mag</p>
                <p><strong>RMS:</strong> <span id="lc-rms">-</span> mag</p>
                <p><strong>Range:</strong> <span id="lc-range">-</span> mag</p>
            </div>
        </div>
    </div>
</div>

<!-- モーダル用のCSS -->
<style>
.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
}

.modal-content {
    background-color: #2a2a2a;
    margin: 5% auto;
    padding: 0;
    border: 1px solid #555;
    border-radius: 8px;
    max-width: 900px;
    max-height: 85vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #444;
}

.modal-header h2 {
    margin: 0;
    color: #fff;
}

.modal-body {
    padding: 20px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #fff;
}

.lc-info {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #1a1a1a;
    border-radius: 4px;
}

.lc-info p {
    margin: 5px 0;
    color: #ccc;
}

.lc-controls {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #1a1a1a;
    border-radius: 4px;
}

.lc-controls label {
    margin-right: 20px;
    color: #ccc;
}

.lc-loading,
.lc-error {
    padding: 20px;
    text-align: center;
    border-radius: 4px;
    margin-bottom: 15px;
}

.lc-loading {
    background-color: #1a4d7a;
    color: #fff;
}

.lc-error {
    background-color: #7a1a1a;
    color: #fff;
}

.lc-stats {
    margin-top: 15px;
    padding: 10px;
    background-color: #1a1a1a;
    border-radius: 4px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.lc-stats p {
    margin: 5px 0;
    color: #ccc;
}
</style>
```

### 3.3 JavaScriptの実装

```javascript
// app.js に追加する関数群

// グローバル変数（ライトカーブデータを保持）
let currentLightCurveData = null;
let currentLightCurveChart = null;

/**
 * ライトカーブを表示
 */
async function showLightCurve(star) {
    // モーダルを表示
    const modal = document.getElementById('lightcurve-modal');
    modal.style.display = 'block';
    
    // ローディング表示
    document.getElementById('lc-loading').style.display = 'block';
    document.getElementById('lc-error').style.display = 'none';
    document.getElementById('lc-chart-container').style.display = 'none';
    document.getElementById('lc-stats').style.display = 'none';
    
    try {
        // APIエンドポイントを構築
        let url;
        if (star.allwise_id) {
            url = `http://localhost:8000/api/lightcurve/neowise?allwise_id=${encodeURIComponent(star.allwise_id)}`;
        } else {
            url = `http://localhost:8000/api/lightcurve/neowise?ra=${star.ra}&dec=${star.dec}&radius=3`;
        }
        
        // APIリクエスト
        const response = await fetch(url);
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        currentLightCurveData = data;
        
        // ターゲット情報を表示
        document.getElementById('lc-allwise-id').textContent = data.allwise_id || '-';
        document.getElementById('lc-coord').textContent = 
            `${data.ra.toFixed(5)}°, ${data.dec.toFixed(5)}°`;
        
        // ローディングを非表示
        document.getElementById('lc-loading').style.display = 'none';
        document.getElementById('lc-chart-container').style.display = 'block';
        document.getElementById('lc-stats').style.display = 'grid';
        
        // ライトカーブをプロット
        updateLightCurveDisplay();
        
    } catch (error) {
        console.error('Error loading light curve:', error);
        
        // エラー表示
        document.getElementById('lc-loading').style.display = 'none';
        document.getElementById('lc-error').style.display = 'block';
        document.getElementById('lc-error-message').textContent = 
            error.message || 'Failed to load light curve';
    }
}

/**
 * ライトカーブ表示を更新（バンド切り替え時）
 */
function updateLightCurveDisplay() {
    if (!currentLightCurveData) return;
    
    // 選択されたバンドを取得
    const band = document.querySelector('input[name="lc-band"]:checked').value;
    
    // データを抽出
    const observations = currentLightCurveData.observations;
    const mjds = observations.map(obs => obs.mjd);
    const mags = observations.map(obs => band === 'w1' ? obs.w1_mag : obs.w2_mag);
    const errs = observations.map(obs => band === 'w1' ? obs.w1_err : obs.w2_err);
    
    // 統計情報を計算
    const mean = mags.reduce((a, b) => a + b, 0) / mags.length;
    const variance = mags.reduce((a, b) => a + (b - mean) ** 2, 0) / mags.length;
    const rms = Math.sqrt(variance);
    const range = Math.max(...mags) - Math.min(...mags);
    
    // 統計情報を表示
    document.getElementById('lc-num-obs').textContent = observations.length;
    document.getElementById('lc-mean').textContent = mean.toFixed(3);
    document.getElementById('lc-rms').textContent = rms.toFixed(3);
    document.getElementById('lc-range').textContent = range.toFixed(3);
    
    // グラフをプロット
    plotLightCurve(mjds, mags, errs, band);
}

/**
 * ライトカーブをプロット
 */
function plotLightCurve(mjds, mags, errs, band) {
    const ctx = document.getElementById('lightcurve-chart').getContext('2d');
    
    // 既存のチャートを破棄
    if (currentLightCurveChart) {
        currentLightCurveChart.destroy();
    }
    
    // エラーバー用のデータポイント
    const dataPoints = mjds.map((mjd, i) => ({
        x: mjd,
        y: mags[i],
        err: errs[i]
    }));
    
    // Chart.jsでプロット
    currentLightCurveChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: `${band.toUpperCase()} magnitude`,
                data: dataPoints,
                backgroundColor: band === 'w1' ? 'rgba(255, 99, 132, 0.6)' : 'rgba(54, 162, 235, 0.6)',
                borderColor: band === 'w1' ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'MJD (Modified Julian Date)',
                        color: '#ccc'
                    },
                    ticks: {
                        color: '#ccc'
                    },
                    grid: {
                        color: '#444'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Magnitude',
                        color: '#ccc'
                    },
                    reverse: true,  // 等級は小さいほど明るい
                    ticks: {
                        color: '#ccc'
                    },
                    grid: {
                        color: '#444'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `NEOWISE Light Curve (${band.toUpperCase()} band)`,
                    color: '#fff',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return `Mag: ${point.y.toFixed(3)} ± ${point.err.toFixed(3)}`;
                        }
                    }
                },
                legend: {
                    labels: {
                        color: '#ccc'
                    }
                }
            }
        }
    });
}

/**
 * ライトカーブモーダルを閉じる
 */
function closeLightCurveModal() {
    const modal = document.getElementById('lightcurve-modal');
    modal.style.display = 'none';
    
    // チャートを破棄
    if (currentLightCurveChart) {
        currentLightCurveChart.destroy();
        currentLightCurveChart = null;
    }
    
    currentLightCurveData = null;
}

// モーダルの外側をクリックしたら閉じる
window.onclick = function(event) {
    const modal = document.getElementById('lightcurve-modal');
    if (event.target == modal) {
        closeLightCurveModal();
    }
}
```

### 3.4 星リストに「LC」ボタンを追加

`app.js`の星リスト生成部分を修正します。具体的な場所は、`renderStarsList()`などの関数内です。

```javascript
// app.js の renderStarsList() 関数内に以下を追加

// 例: カード表示モードの場合
function renderStarsCards() {
    const container = document.getElementById('stars-list');
    container.innerHTML = '';
    
    this.starsInFov.forEach((star, index) => {
        const card = document.createElement('div');
        card.className = 'star-card';
        
        // 既存のカード内容...
        
        // ライトカーブボタンを追加
        const lcButton = document.createElement('button');
        lcButton.className = 'lc-button';
        lcButton.textContent = 'LC';
        lcButton.title = 'Show Light Curve';
        lcButton.onclick = (e) => {
            e.stopPropagation();
            showLightCurve(star);
        };
        
        // カードにボタンを追加
        card.appendChild(lcButton);
        container.appendChild(card);
    });
}
```

ボタンのスタイルを追加:

```css
/* index.html または viewer.html の<style>内に追加 */

.lc-button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 5px 10px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 4px;
}

.lc-button:hover {
    background-color: #45a049;
}

.lc-button:active {
    transform: scale(0.95);
}
```

---

## 第4週: 統合テストと評価

### 4.1 機能テスト

#### 4.1.1 バックエンドAPIのテスト

```bash
# 1. サーバーを起動
cd backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

テストケース:

1. **正常系: AllWISE IDで検索**
   ```bash
   curl "http://localhost:8000/api/lightcurve/neowise?allwise_id=<実際のID>"
   ```
   - ステータスコード: 200
   - レスポンス: ライトカーブデータ（JSON）

2. **正常系: 座標で検索**
   ```bash
   curl "http://localhost:8000/api/lightcurve/neowise?ra=188.753&dec=-20.086&radius=3"
   ```
   - ステータスコード: 200
   - レスポンス: ライトカーブデータ（JSON）

3. **異常系: パラメータ不足**
   ```bash
   curl "http://localhost:8000/api/lightcurve/neowise"
   ```
   - ステータスコード: 400
   - エラーメッセージ

4. **異常系: データが見つからない**
   ```bash
   curl "http://localhost:8000/api/lightcurve/neowise?allwise_id=NONEXISTENT"
   ```
   - ステータスコード: 404
   - エラーメッセージ

#### 4.1.2 フロントエンドのテスト

1. **ブラウザで動作確認**
   - `index.html`または`viewer.html`を開く
   - カタログを読み込む
   - 星リストで「LC」ボタンが表示されることを確認
   - 「LC」ボタンをクリック
   - ライトカーブモーダルが表示されることを確認
   - グラフが正しく表示されることを確認
   - W1/W2バンドの切り替えが動作することを確認

2. **エラーハンドリングの確認**
   - APIサーバーを停止した状態で「LC」ボタンをクリック
   - エラーメッセージが表示されることを確認

### 4.2 パフォーマンステスト

```bash
# Apache Benchでパフォーマンステスト
ab -n 100 -c 10 "http://localhost:8000/api/lightcurve/neowise?allwise_id=<実際のID>"
```

目標値:
- レスポンスタイム: < 100ms（中央値）
- スループット: > 100 req/s

### 4.3 評価とフィードバック収集

#### 4.3.1 評価項目

| 項目 | 評価基準 | 結果 |
|------|----------|------|
| API応答速度 | < 100ms | ✓/✗ |
| UI操作性 | 直感的に操作可能 | ✓/✗ |
| グラフ表示 | データが正しく表示される | ✓/✗ |
| エラーハンドリング | 適切なエラーメッセージ | ✓/✗ |
| モバイル対応 | スマホでも使用可能 | ✓/✗ |

#### 4.3.2 改善点のリスト作成

テスト結果をもとに、以下をまとめます:

1. **技術的課題**
   - パフォーマンスのボトルネック
   - バグや不具合
   - セキュリティの懸念

2. **UI/UXの改善点**
   - 使いにくい点
   - 追加してほしい機能
   - デザインの改善

3. **次フェーズへの提言**
   - 本番実装で必要な機能
   - 優先度の高い改善項目
   - リソース見積もりの調整

---

## 完成チェックリスト

### 第1週
- [ ] Python開発環境のセットアップ完了
- [ ] 必要なパッケージのインストール完了
- [ ] NEOWISEサンプルデータ（100個）の準備完了
- [ ] SQLiteデータベースの作成完了
- [ ] データベースへのデータ投入完了

### 第2週
- [ ] FastAPIプロジェクト構造の作成完了
- [ ] データベース接続モジュールの実装完了
- [ ] Pydanticモデルの定義完了
- [ ] APIエンドポイントの実装完了
- [ ] APIサーバーの起動確認完了
- [ ] Swagger UIでAPIドキュメント確認完了

### 第3週
- [ ] Chart.jsの導入完了
- [ ] ライトカーブモーダルUIの追加完了
- [ ] JavaScript実装完了
- [ ] 星リストに「LC」ボタン追加完了
- [ ] ブラウザでの動作確認完了

### 第4週
- [ ] バックエンドAPIの機能テスト完了
- [ ] フロントエンドの機能テスト完了
- [ ] パフォーマンステスト完了
- [ ] 評価とフィードバック収集完了
- [ ] 改善点リストの作成完了
- [ ] 次フェーズへの提言まとめ完了

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. CORS エラー

**症状**: ブラウザのコンソールに「CORS policy」エラーが表示される

**解決方法**:
```python
# app/main.py のCORS設定を確認
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # すべてのオリジンを許可（開発環境のみ）
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### 2. データベースファイルが見つからない

**症状**: `sqlite3.OperationalError: unable to open database file`

**解決方法**:
```python
# app/database.py のパスを確認
DATABASE_PATH = "./neowise_prototype.db"  # 相対パス

# または絶対パスを使用
import os
DATABASE_PATH = os.path.join(os.path.dirname(__file__), "..", "neowise_prototype.db")
```

#### 3. Chart.jsが読み込まれない

**症状**: グラフが表示されず、コンソールに「Chart is not defined」エラー

**解決方法**:
```html
<!-- CDNのURLを確認 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- または、ローカルにダウンロードして使用 -->
<script src="./lib/chart.min.js"></script>
```

#### 4. APIレスポンスが遅い

**症状**: ライトカーブの表示に時間がかかる

**解決方法**:
```python
# データベースのインデックスを確認
# schema.sql
CREATE INDEX idx_ra_dec ON lightcurves(ra, dec);
CREATE INDEX idx_allwise_id ON lightcurves(allwise_id);
CREATE INDEX idx_lightcurve_id ON observations(lightcurve_id);
```

---

## 次のステップ

プロトタイプの完成後、以下を検討します:

### ステップ2への移行判断

以下の条件が満たされた場合、ステップ2（NEOWISE本格実装）に進みます:

1. **技術的実現性の確認**
   - APIが期待通りに動作する
   - パフォーマンスが許容範囲内
   - UI/UXが使いやすい

2. **ビジネス判断**
   - 予算の確保
   - サーバーリソースの確保
   - 利用者数の見積もり

3. **改善計画の策定**
   - プロトタイプで発見された課題の解決方法
   - 優先順位の決定
   - スケジュールの調整

### ステップ2の準備

1. **全天データの準備**
   - NEOWISEの全データをダウンロード（数百GB）
   - データベースの設計見直し（PostgreSQLへの移行検討）
   - ストレージの確保

2. **本番環境の構築**
   - サーバーの調達
   - Dockerコンテナの構築
   - Nginxの設定
   - SSL証明書の取得

3. **監視・運用の準備**
   - ログ収集の仕組み
   - エラー監視
   - パフォーマンス監視
   - バックアップ戦略

---

## まとめ

このプロトタイプ実装により、以下が達成されます:

1. **技術検証**: FastAPI + SQLite + Chart.jsの組み合わせの有効性確認
2. **UI/UX検証**: ライトカーブ表示機能の使いやすさ確認
3. **パフォーマンス検証**: 少数のデータでの応答速度確認
4. **リスク軽減**: 本格実装前に課題を発見・対処

プロトタイプの評価結果をもとに、ステップ2（NEOWISE本格実装）への移行を判断してください。

---

**文書作成日**: 2025年11月21日  
**作成者**: GitHub Copilot Agent  
**バージョン**: 1.0
