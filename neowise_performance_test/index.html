<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEOWISE Performance Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4CAF50;
        }

        .section {
            background-color: #2a2a2a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .section h2 {
            margin-top: 0;
            color: #4CAF50;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="file"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #fff;
            box-sizing: border-box;
        }

        textarea {
            min-height: 100px;
            font-family: monospace;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        button.primary {
            background-color: #4CAF50;
            color: white;
        }

        button.primary:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #2196F3;
            color: white;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .status.info {
            background-color: #2196F3;
        }

        .status.success {
            background-color: #4CAF50;
        }

        .status.error {
            background-color: #f44336;
        }

        .status.warning {
            background-color: #ff9800;
        }

        .results {
            margin-top: 20px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .comparison-table th {
            background-color: #1a1a1a;
            color: #4CAF50;
            font-weight: bold;
        }

        .comparison-table tr:hover {
            background-color: #333;
        }

        .highlight {
            color: #4CAF50;
            font-weight: bold;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .details-table th,
        .details-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .details-table th {
            background-color: #1a1a1a;
            color: #4CAF50;
        }

        .details-table .success {
            color: #4CAF50;
        }

        .details-table .error {
            color: #f44336;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background-color: #1a4d7a;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            margin-top: 0;
            color: #4CAF50;
        }

        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-box code {
            background-color: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NEOWISE ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h1>

        <div class="info-box">
            <h3>ğŸ¯ ãƒ†ã‚¹ãƒˆã®ç›®çš„</h3>
            <p>NEOWISEæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—æ–¹æ³•ã‚’æ¯”è¼ƒã—ã€æœ€é©ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ±ºå®šã—ã¾ã™ï¼š</p>
            <ul>
                <li><strong>query_region</strong>: åº§æ¨™ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰</li>
                <li><strong>query_tap</strong>: TAPï¼ˆTable Access Protocolï¼‰ã‚’ä½¿ç”¨ã—ãŸæ¤œç´¢ï¼ˆallwise_cntræŒ‡å®šã§é«˜é€ŸåŒ–ã®å¯èƒ½æ€§ï¼‰</li>
            </ul>
            <p><strong>API Endpoint:</strong> <code>http://localhost:8000</code></p>
        </div>

        <!-- ã‚«ã‚¿ãƒ­ã‚°èª­ã¿è¾¼ã¿ -->
        <div class="section">
            <h2>ğŸ“ 1. ã‚«ã‚¿ãƒ­ã‚°ã®æº–å‚™</h2>
            
            <div class="input-group">
                <label for="catalog-file">ã‚«ã‚¿ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCSVï¼‰</label>
                <input type="file" id="catalog-file" accept=".csv">
                <small style="color: #aaa;">â€» BrightKg_WISE_unique.csv ã¾ãŸã¯åŒå½¢å¼ã®CSVãƒ•ã‚¡ã‚¤ãƒ«</small>
            </div>

            <div class="input-group">
                <label for="num-stars">ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®æ˜Ÿæ•°</label>
                <input type="number" id="num-stars" value="10" min="1" max="100">
                <small style="color: #aaa;">â€» å¤šã™ãã‚‹ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼ˆæ¨å¥¨: 5-20å€‹ï¼‰</small>
            </div>

            <div class="button-group">
                <button class="primary" onclick="loadCatalog()">ã‚«ã‚¿ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€</button>
            </div>

            <div id="catalog-status"></div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ -->
        <div class="section">
            <h2>ğŸš€ 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ</h2>
            
            <p style="color: #aaa;">èª­ã¿è¾¼ã‚“ã ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰å„æ–¹æ³•ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€æ‰€è¦æ™‚é–“ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚</p>

            <div class="button-group">
                <button class="primary" id="test-region-btn" onclick="runTest('query_region')" disabled>
                    query_region ã§ãƒ†ã‚¹ãƒˆ
                </button>
                <button class="secondary" id="test-tap-btn" onclick="runTest('query_tap')" disabled>
                    query_tap ã§ãƒ†ã‚¹ãƒˆ
                </button>
                <button class="secondary" id="test-both-btn" onclick="runBothTests()" disabled>
                    ä¸¡æ–¹ã‚’æ¯”è¼ƒãƒ†ã‚¹ãƒˆ
                </button>
            </div>

            <div id="test-status"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div class="section results" id="results-section" style="display: none;">
            <h2>ğŸ“Š 3. ãƒ†ã‚¹ãƒˆçµæœ</h2>

            <!-- æ¯”è¼ƒã‚µãƒãƒªãƒ¼ -->
            <div id="comparison-summary"></div>

            <!-- è©³ç´°çµæœ -->
            <div id="detailed-results"></div>

            <!-- ã‚°ãƒ©ãƒ• -->
            <div class="chart-container">
                <canvas id="performance-chart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let catalogData = [];
        let testResults = {
            query_region: null,
            query_tap: null
        };

        const API_URL = 'http://localhost:8000';

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function loadCatalog() {
            const fileInput = document.getElementById('catalog-file');
            const numStars = parseInt(document.getElementById('num-stars').value);

            if (!fileInput.files || !fileInput.files[0]) {
                showStatus('catalog-status', 'ã‚«ã‚¿ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const file = fileInput.files[0];
            showStatus('catalog-status', `ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­: ${file.name}...`, 'info');

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        showStatus('catalog-status', 'ã‚«ã‚¿ãƒ­ã‚°ãŒç©ºã§ã™', 'error');
                        return;
                    }

                    // å¿…è¦ãªã‚«ãƒ©ãƒ ãŒã‚ã‚‹ã‹ç¢ºèª
                    const firstRow = results.data[0];
                    if (!('ra' in firstRow) || !('dec' in firstRow)) {
                        showStatus('catalog-status', 'raã¾ãŸã¯decã‚«ãƒ©ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        return;
                    }

                    // numStarså€‹ã ã‘æŠ½å‡ºï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
                    const validData = results.data.filter(row => 
                        row.ra != null && row.dec != null && !isNaN(row.ra) && !isNaN(row.dec)
                    );

                    if (validData.length === 0) {
                        showStatus('catalog-status', 'æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        return;
                    }

                    // ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
                    const shuffled = validData.sort(() => 0.5 - Math.random());
                    catalogData = shuffled.slice(0, Math.min(numStars, shuffled.length));

                    // ã‚«ã‚¿ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’æº–å‚™
                    catalogData = catalogData.map((row, index) => ({
                        source_id: row.Source || row.source_id || `Star_${index + 1}`,
                        ra: row.ra,
                        dec: row.dec,
                        allwise_id: row.AllWISE_ID || row.allwise_id || null
                    }));

                    showStatus('catalog-status', 
                        `âœ“ ${catalogData.length}å€‹ã®å¤©ä½“ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 
                        'success'
                    );

                    // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    document.getElementById('test-region-btn').disabled = false;
                    document.getElementById('test-tap-btn').disabled = false;
                    document.getElementById('test-both-btn').disabled = false;
                },
                error: function(error) {
                    showStatus('catalog-status', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            });
        }

        async function runTest(method) {
            if (catalogData.length === 0) {
                showStatus('test-status', 'ã¾ãšã‚«ã‚¿ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            // UIã‚’æ›´æ–°
            document.getElementById('loading').classList.add('active');
            showStatus('test-status', `${method} ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...`, 'info');
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('test-region-btn').disabled = true;
            document.getElementById('test-tap-btn').disabled = true;
            document.getElementById('test-both-btn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/test-performance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        catalog_entries: catalogData,
                        method: method
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                testResults[method] = result;

                showStatus('test-status', 
                    `âœ“ ${method} ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆåˆè¨ˆ: ${result.total_time.toFixed(2)}ç§’ï¼‰`, 
                    'success'
                );

                // çµæœã‚’è¡¨ç¤º
                displayResults();

            } catch (error) {
                console.error('Error:', error);
                showStatus('test-status', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading').classList.remove('active');
                
                // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                document.getElementById('test-region-btn').disabled = false;
                document.getElementById('test-tap-btn').disabled = false;
                document.getElementById('test-both-btn').disabled = false;
            }
        }

        async function runBothTests() {
            await runTest('query_region');
            await new Promise(resolve => setTimeout(resolve, 2000)); // 2ç§’å¾…æ©Ÿ
            await runTest('query_tap');
        }

        function displayResults() {
            const resultsSection = document.getElementById('results-section');
            resultsSection.style.display = 'block';

            // æ¯”è¼ƒã‚µãƒãƒªãƒ¼
            displayComparisonSummary();

            // è©³ç´°çµæœ
            displayDetailedResults();

            // ã‚°ãƒ©ãƒ•
            displayChart();

            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayComparisonSummary() {
            const summaryDiv = document.getElementById('comparison-summary');
            
            let html = '<h3>æ¯”è¼ƒã‚µãƒãƒªãƒ¼</h3>';
            html += '<table class="comparison-table">';
            html += '<thead><tr><th>æŒ‡æ¨™</th><th>query_region</th><th>query_tap</th><th>å·®åˆ†</th></tr></thead>';
            html += '<tbody>';

            const metrics = [
                { label: 'åˆè¨ˆæ™‚é–“', key: 'total_time', unit: 'ç§’' },
                { label: 'å¹³å‡æ™‚é–“/æ˜Ÿ', key: 'avg_time_per_star', unit: 'ç§’' },
                { label: 'æœ€å°æ™‚é–“', key: 'min_time', unit: 'ç§’' },
                { label: 'æœ€å¤§æ™‚é–“', key: 'max_time', unit: 'ç§’' },
                { label: 'æˆåŠŸæ•°', key: 'successful_queries', unit: 'å€‹' },
                { label: 'å¤±æ•—æ•°', key: 'failed_queries', unit: 'å€‹' }
            ];

            metrics.forEach(metric => {
                const regionValue = testResults.query_region ? testResults.query_region[metric.key] : null;
                const tapValue = testResults.query_tap ? testResults.query_tap[metric.key] : null;

                let regionText = regionValue !== null ? `${regionValue.toFixed(3)} ${metric.unit}` : '-';
                let tapText = tapValue !== null ? `${tapValue.toFixed(3)} ${metric.unit}` : '-';
                let diffText = '-';

                if (regionValue !== null && tapValue !== null && metric.key !== 'successful_queries' && metric.key !== 'failed_queries') {
                    const diff = regionValue - tapValue;
                    const percent = (diff / regionValue * 100).toFixed(1);
                    const faster = diff > 0 ? 'query_tap' : 'query_region';
                    diffText = `<span class="highlight">${Math.abs(diff).toFixed(3)}ç§’ (${Math.abs(percent)}%) ${faster}ã®æ–¹ãŒé€Ÿã„</span>`;
                }

                html += `<tr><td>${metric.label}</td><td>${regionText}</td><td>${tapText}</td><td>${diffText}</td></tr>`;
            });

            html += '</tbody></table>';

            // æ¨å¥¨äº‹é …
            if (testResults.query_region && testResults.query_tap) {
                const regionAvg = testResults.query_region.avg_time_per_star;
                const tapAvg = testResults.query_tap.avg_time_per_star;
                
                html += '<div style="margin-top: 20px; padding: 15px; background-color: #1a4d7a; border-radius: 4px;">';
                html += '<h4>ğŸ’¡ æ¨å¥¨äº‹é …</h4>';
                
                if (tapAvg < regionAvg) {
                    const improvement = ((regionAvg - tapAvg) / regionAvg * 100).toFixed(1);
                    html += `<p><strong>query_tap</strong>ã®æ–¹ãŒç´„<strong>${improvement}%</strong>é«˜é€Ÿã§ã™ã€‚`;
                    if (improvement > 30) {
                        html += ' <span class="highlight">å¤§å¹…ãªæ”¹å–„ãŒè¦‹è¾¼ã‚ã‚‹ãŸã‚ã€query_tapã®æ¡ç”¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚</span>';
                    } else if (improvement > 10) {
                        html += ' æœ‰æ„ãªæ”¹å–„ãŒè¦‹ã‚‰ã‚Œã‚‹ãŸã‚ã€query_tapã®æ¡ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
                    } else {
                        html += ' è‹¥å¹²ã®æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ãŒã€å®Ÿè£…ã®è¤‡é›‘ã•ã‚‚è€ƒæ…®ã—ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚';
                    }
                    html += '</p>';
                } else {
                    html += '<p>query_regionã¨query_tapã®æ€§èƒ½å·®ã¯å°ã•ã„ãŸã‚ã€å®Ÿè£…ã®ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’å„ªå…ˆã—ã¦query_regionã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>';
                }
                
                html += '</div>';
            }

            summaryDiv.innerHTML = html;
        }

        function displayDetailedResults() {
            const detailedDiv = document.getElementById('detailed-results');
            
            let html = '<h3>è©³ç´°çµæœ</h3>';

            ['query_region', 'query_tap'].forEach(method => {
                if (!testResults[method]) return;

                html += `<h4>${method}</h4>`;
                html += '<table class="details-table">';
                html += '<thead><tr><th>Source ID</th><th>RA</th><th>Dec</th><th>AllWISE ID</th><th>æ™‚é–“(ç§’)</th><th>è¦³æ¸¬æ•°</th><th>çŠ¶æ…‹</th></tr></thead>';
                html += '<tbody>';

                testResults[method].results.forEach(result => {
                    const statusClass = result.success ? 'success' : 'error';
                    const statusText = result.success ? 'âœ“ æˆåŠŸ' : `âœ— å¤±æ•—: ${result.error_message}`;
                    
                    html += `<tr>
                        <td>${result.source_id}</td>
                        <td>${result.ra.toFixed(5)}</td>
                        <td>${result.dec.toFixed(5)}</td>
                        <td>${result.allwise_id || '-'}</td>
                        <td>${result.query_time.toFixed(3)}</td>
                        <td>${result.num_observations}</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
            });

            detailedDiv.innerHTML = html;
        }

        function displayChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (window.performanceChart) {
                window.performanceChart.destroy();
            }

            const labels = catalogData.map(entry => entry.source_id);
            const datasets = [];

            if (testResults.query_region) {
                datasets.push({
                    label: 'query_region',
                    data: testResults.query_region.results.map(r => r.query_time),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                });
            }

            if (testResults.query_tap) {
                datasets.push({
                    label: 'query_tap',
                    data: testResults.query_tap.results.map(r => r.query_time),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                });
            }

            window.performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'å¤©ä½“',
                                color: '#ccc'
                            },
                            ticks: {
                                color: '#ccc'
                            },
                            grid: {
                                color: '#444'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'å–å¾—æ™‚é–“ (ç§’)',
                                color: '#ccc'
                            },
                            ticks: {
                                color: '#ccc'
                            },
                            grid: {
                                color: '#444'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'ã‚¯ã‚¨ãƒªæ€§èƒ½æ¯”è¼ƒï¼ˆå¤©ä½“ã”ã¨ï¼‰',
                            color: '#fff',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            labels: {
                                color: '#ccc'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
